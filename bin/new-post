#!/usr/bin/env bash

# Script to create a new Hugo post with date prefix
# Usage: new-post [-e|--edit] "post title"

set -e

# Parse flags
edit_after=false
post_title=""

while [[ $# -gt 0 ]]; do
    case $1 in
        -e|--edit)
            edit_after=true
            shift
            ;;
        *)
            post_title="$1"
            shift
            ;;
    esac
done

if [ -z "$post_title" ]; then
    echo "Usage: $0 [-e|--edit] \"post title\""
    echo "Example: $0 \"my blog update\""
    echo "Example: $0 -e \"my blog update\""
    echo ""
    echo "Options:"
    echo "  -e, --edit    Open the new post in \$EDITOR after creation"
    exit 1
fi

# Get current date in YYYY-MM-DD format
current_date=$(date +%Y-%m-%d)

# Convert title to slug format (lowercase, replace spaces with hyphens, remove special chars)
slug=$(echo "$post_title" | tr '[:upper:]' '[:lower:]' | tr -s ' ' | tr ' ' '-' | sed 's/[^a-z0-9-]//g' | sed 's/^-\+\|-\+$//g')

# Create filename with date prefix
filename="${current_date}-${slug}.md"

# Run hugo new content command
hugo new content "posts/${filename}"

echo "‚úÖ New post created successfully!"
echo "üìù Edit your post: $filename"

# Open in editor if flag was set
if [ "$edit_after" = true ]; then
    if [ -z "$EDITOR" ]; then
        echo "‚ö†Ô∏è  Warning: \$EDITOR environment variable is not set. Cannot open editor."
        exit 1
    fi
    filepath="content/posts/${filename}"
    echo "üöÄ Opening in \$EDITOR..."
    exec "$EDITOR" "$filepath"
fi
